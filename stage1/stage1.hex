;; esi : current number
;; edi : loop var for the main loop, how many bytes to be put
;; ebp : loop var for the nested read byte loop

;; init:
C7 C6 00000000    ;; mov esi, 0
C7 C7 00000000    ;; mov edi, 0
E9 XXXXXXXX       ;; jmp loop

;; clear the comments
;; clear:
               ;; read 1 byte
68 00000000       ;; push 0
89 E1             ;; mov ecx, esp
               ;; sys_read(fd=0, buf=ecx, count=1)
C7 C0 00000003    ;; mov eax, 3
C7 C3 00000000    ;; mov ebx, 0
C7 C2 00000001    ;; mov edx, 1
CD 80             ;; int 0x80

               ;; if ch != '\n' goto clear
58                ;; pop eax
81 F8 0000000A    ;; cmp eax, 0x0A
0F 85 XXXXXXXX    ;; jne clear
    
;; loop:
C7 C5 00000000    ;; mov ebp, 0

;; readbyte:
               ;; read 1 byte
68 00000000       ;; push 0
               ;; sys_read(fd=0, buf=ecx, count=1)
C7 C0 00000003    ;; mov eax, 3
C7 C3 00000000    ;; mov ebx, 0
89 E1             ;; mov ecx, esp
C7 C2 00000001    ;; mov edx, 1
CD 80             ;; int 0x80

               ;; if EOF done
81 F8 00000000    ;; cmp eax, 0
0F 84 XXXXXXXX    ;; je done

               ;; get char
58                ;; pop eax

               ;; if ch == ';' goto clear
81 F8 0000003B    ;; cmp eax, 0x3B
0F 84 XXXXXXXX    ;; je clear

               ;; if ch <= 0x20 (white) goto emit
81 F8 00000020    ;; cmp eax, 0x20 
0F 86 XXXXXXXX    ;; jbe emit

               ;; if ch < 0x40 (digits) goto mask
81 F8 00000040    ;; cmp eax, 0x40
0F 82 XXXXXXXX    ;; jb mask

               ;; ch -= 7
81 E8 00000007    ;; sub eax, 0x7

;; mask:
81 E0 0000000F    ;; and eax, 0xF
               ;; esi = (esi << 4) | eax
C1 F6 04          ;; shl esi, 4
09 C6             ;; or esi, eax

81 C5 00000001    ;; add ebp, 1
81 FD 00000002    ;; cmp ebp, 2
0F 82 XXXXXXXX    ;; jb readbyte  ;; 2 digits = 1 byte

81 C7 00000001    ;; add edi, 1    
E9 XXXXXXXX       ;; jmp loop

;; emit:
               ;; if it reads nothing
81 FF 00000000    ;; cmp edi, 0
0F 84 XXXXXXXX    ;; je loop

               ;; emit byte
89 F0             ;; mov eax, esi
81 20 000000FF    ;; and eax, 0xFF   ;; lower byte
C1 EE 04          ;; shr esi, 8

               ;; write byte
50                ;; push eax
C7 C0 00000004    ;; mov eax, 4
C7 C3 00000001    ;; mov ebx, 1
89 E1             ;; mov ecx, esp
C7 C2 00000001    ;; mov edx, 1
CD 80             ;; int 0x80
58                ;; pop eax

81 EF 00000001    ;; sub edi, 1
81 FF 00000000    ;; cmp edi, 0
0F 87 XXXXXXXX    ;; ja emit
E9 XXXXXXXX       ;; jmp loop

;; done:
C7 C0 00000001    ;; mov eax, 1
C7 C3 00000000    ;; mov ebx, 0
CD 80             ;; int 0x80

