;; ELF header:
7F 45 4C 46 01 01 01 00
00 00 00 00 00 00 00 00

0002     ; type
0003     ; machine
00000000 ; version
00010054 ; entry
00000034 ; phoff
00000000 ; shoff
00000000 ; flags
0034     ; ehsize
0020     ; phentsize
0001     ; phnum
0000     ; shentsize
0000     ; shnum
0000     ; shstrndx

;; Program header:
00000001 ; type
00000000 ; offset
00010000 ; vaddr
00000000 ; paddr
00000171 ; filesz
00010000 ; memsz (over-estimate)
00000007 ; flags
00001000 ; alginment

;; esi : current number
;; edi : loop var for the main loop, how many bytes to be put
;; ebp : loop var for the nested read byte loop

;; init:
C7 C6 00000000    ;; mov esi, 0
C7 C7 00000000    ;; mov edi, 0
E9 00000028       ;; jmp loop(+40)

;; clear the comments
;; clear:
               ;; read 1 byte
68 00000000       ;; push 0
89 E1             ;; mov ecx, esp
               ;; sys_read(fd=0, buf=ecx, count=1)
C7 C0 00000003    ;; mov eax, 3
C7 C3 00000000    ;; mov ebx, 0
C7 C2 00000001    ;; mov edx, 1
CD 80             ;; int 0x80

               ;; if ch != '\n' goto clear
58                ;; pop eax
81 F8 0000000A    ;; cmp eax, 0x0A
0F 85 FFFFFFD8    ;; jne clear(-40)
    
;; loop:
C7 C5 00000000    ;; mov ebp, 0

;; readbyte:
               ;; read 1 byte
68 00000000       ;; push 0
               ;; sys_read(fd=0, buf=ecx, count=1)
C7 C0 00000003    ;; mov eax, 3
C7 C3 00000000    ;; mov ebx, 0
89 E1             ;; mov ecx, esp
C7 C2 00000001    ;; mov edx, 1
CD 80             ;; int 0x80

               ;; if EOF done
81 F8 00000000    ;; cmp eax, 0
0F 84 00000099    ;; je done(+153)

               ;; get char
58                ;; pop eax

               ;; if ch == ';' goto clear
81 F8 0000003B    ;; cmp eax, 0x3B
0F 84 FFFFFF9E    ;; je clear(-98)

               ;; if ch <= 0x20 (white) goto emit
81 F8 00000020    ;; cmp eax, 0x20 
0F 86 0000003A    ;; jbe emit(+58)

               ;; if ch < 0x40 (digits) goto mask
81 F8 00000040    ;; cmp eax, 0x40
0F 82 00000006    ;; jb mask(+6)

               ;; ch -= 7
81 E8 00000007    ;; sub eax, 0x7

;; mask:
81 E0 0000000F    ;; and eax, 0xF
               ;; esi = (esi << 4) | eax
C1 F6 04          ;; shl esi, 4
09 C6             ;; or esi, eax

81 C5 00000001    ;; add ebp, 1
81 FD 00000002    ;; cmp ebp, 2
0F 82 FFFFFF91    ;; jb readbyte(-111)  ;; 2 digits = 1 byte

81 C7 00000001    ;; add edi, 1    
E9 FFFFFF80       ;; jmp loop(-128)

;; emit:
               ;; if it reads nothing
81 FF 00000000    ;; cmp edi, 0
0F 84 FFFFFF74    ;; je loop(-140)

               ;; emit byte
89 F0             ;; mov eax, esi
81 E0 000000FF    ;; and eax, 0xFF   ;; lower byte
C1 EE 08          ;; shr esi, 8

               ;; write byte
50                ;; push eax
C7 C0 00000004    ;; mov eax, 4
C7 C3 00000001    ;; mov ebx, 1
89 E1             ;; mov ecx, esp
C7 C2 00000001    ;; mov edx, 1
CD 80             ;; int 0x80
58                ;; pop eax

81 EF 00000001    ;; sub edi, 1
81 FF 00000000    ;; cmp edi, 0
0F 87 FFFFFFBF    ;; ja emit
E9 FFFFFF3A       ;; jmp loop(-198)

;; done:
C7 C0 00000001    ;; mov eax, 1
C7 C3 00000000    ;; mov ebx, 0
CD 80             ;; int 0x80

